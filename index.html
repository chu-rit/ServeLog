<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>봉사시간 기록</title>
    <meta name="viewport" content="initial-scale=1, viewport-fit=cover, width=device-width, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="HandheldFriendly" content="true">
    
    <link rel="shortcut icon" href="homeicon.png" type="image/x-icon">
    <link rel="apple-touch-icon" href="homeicon.png" />
    <link rel="icon" href="homeicon.png" type="image/x-icon">
    <meta property="og:title" content="봉시시간 기록" />
    <meta property="og:image" content="homeicon.jpg" />

    <script src="vendor/vue.min.js"></script>

    <link rel="stylesheet" href="vendor/fontawesome/css/all.min.css">
</head>

<body>
    <style>
        /* http://meyerweb.com/eric/tools/css/reset/   v2.0 | 20110126 */
        html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video { margin: 0; padding: 0; border: 0; font-size: 100%; font: inherit; vertical-align: middle; }

        /* HTML5 display-role reset for older browsers */
        article, aside, details, figcaption, figure, footer, header, hgroup, menu, nav, section { display: block; }
        body { line-height: 1; 
            -ms-user-select: none; 
            -moz-user-select: -moz-none;
            -khtml-user-select: none;
            -webkit-user-select: none;
            user-select: none;}
        ol, ul { list-style: none; }
        blockquote, q { quotes: none; }
        blockquote:before, blockquote:after, q:before, q:after { content: ''; content: none; }
        table { border-collapse: collapse; border-spacing: 0; }
        strong { font-weight: bold;}
        *, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
        a { text-decoration: none; }
        html{ -webkit-text-size-adjust: none; text-size-adjust: none; touch-action: pan-y;}
        .textarea {user-select: text;}

        /* app custom by 128bit | 20230210 */
        .app {width: 100vw; height: 100vh; padding: 0px; background-color: #f6f3f1;}
        .headerbar {padding-top: 50px; position: relative; color: #333; background: #fff;}
        .headerbar .title {font-size: 20px; font-weight: bold; text-align: center; padding:0 25vw; display: flex; justify-content: space-between; align-items: center;}
        .headerbar .set_btn {position: absolute; right: 25px; top: 52px;}
        .headerbar .set_btn i {font-size: 25px; color: #333;}
        .cal,.cal2 {width: 100%; background: #fff; box-shadow: 2px 2px 16px rgba(0,0,0,0.2); padding:10px;}
        body {color: #666; font: 14px/24px "Open Sans", "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", Sans-Serif;}
        table {width: 100%; table-layout: fixed;}
        th {padding: 0 3px; font-size: 13px; color: #666; font-weight: bold; }
        th.weekend {color: #D1635D;}
        td {font-size: 15px; text-align: center;}
        td>div {border-radius: 16px; height: 74px; padding: 3px; overflow: visible; border:3px solid #fff; position: relative;}
        .cal2 td>div {height: 54px;} 
        td .date {color: #000; font-weight: bold;}
        td .date2 {color: #000; opacity: 0.2;}
        td .half {display: block;  margin-bottom: -6px; height: 22px;}
        td .hours_sum {
            color: #2f200b; 
            font-size: 12px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-top: -4px;
        }
        td .assist_time {
            color: #65C891;
            font-size: 12px;
        }
        td .extra_report {display: flex; flex-wrap: wrap; justify-content: center; min-height: 15px; align-items: center; margin-top: 1px; width: 35px; margin-left: auto; margin-right: auto;}
        td .extra_report p {border-radius: 24px; width: 5px; height: 5px; margin: 1px;}
        td .extra_report .studies_sum {background-color: #0bc0ed;}
        td .sub_sum {display: inline-block;}
        /* tr:nth-child(even) td>div {background: #e3e3e3;} */

        .today>div  {border:3px solid #c7b3a6;  background: #eae4e0;}
        .today2>div {border:3px solid #c7b3a6;  background: #eae4e0;}
        .sltday>div {border:3px solid #D1635D;}

        /* Long-press visual feedback (UI A) */
        td.select > div { box-shadow: inset 0 0 0 2px #D1635D; }

        

        .itmbar {padding: 10px 10px 30px 10px; width: 100vw; position: fixed; bottom: 0; color: #fff; background-color: #231306; box-shadow: 0px 0px 10px rgba(0,0,0,0.1); border-radius: 30px 30px 0 0;}
        .itmbar a {display: block; color: #fff; height: 30px; padding: 6px 0; border-radius: 8px; position: relative; overflow: hidden; background-color: white; padding-left: 12px;}
        .itmbar a i {color: #000; position: absolute; z-index: 9;}
        .itmbar a::after {content: ""; display: block; width: 15px; height: 100%; position: absolute; left: 0; top: 0; transition: width 200ms ease-out;}
        .itmbar h3 {font-size: 14px; margin-bottom: 6px; display: block; text-align: center; font-weight: 700;}
        .itmbar ul {display: flex; justify-content: space-around;}
        .itmbar i {font-size: 18px;}
        .itmbar td {font-weight: bold; font-size: 14px; color: #fff;}
        .itmbar span {font-weight: bold; font-size: 14px; color: #fff; margin-left: 4px;}
        .itmbar table .active i {color: #fff;}
        .itmbar .active::after {width: 100%;}

        /* yearly summary (inside bottom bar) */
        .year_summary {margin-top: 6px;}
        .year_summary .ym_table {width: 100%; table-layout: fixed; border-collapse: collapse;}
        .year_summary .ym_table td {padding: 4px 2px; text-align: center; vertical-align: middle;}
        .year_summary .ym_table td {cursor: pointer;}
        .year_summary .ym_label {display:block; color:#b7b2ae; font-size: 11px;}
        .year_summary .ym_time {display:block; color:#fff; font-weight: 700; font-size: 12px;}
        /* toggle buttons (classic style) */
        .time .toggle {display:inline-block; padding:4px 8px; border:1px solid #b7b2ae; border-radius:6px; margin-right:4px; color:#333; background:#fff; font-size:12px;}
        .time .toggle.active {background:#231306; color:#fff; border-color:#231306;}
        /* drag handle icon */
        .itmbar .drag_handle {width: 100%; display: flex; justify-content: center; align-items: center; margin-bottom: 6px; touch-action: none; cursor: ns-resize;}
        .itmbar .drag_handle i {color: #b7b2ae; font-size: 20px;}
        /* yearly summary reveal wrapper */
        .year_summary_wrap {height: 0; overflow: hidden; transition: height 120ms ease-out;}
        .year_title {text-align: center; color: #fff; font-size: 12px; margin: 0; padding: 4px 0 2px; font-weight: 700;}
        /* assist icon (FA layered: clock + plus badge) */
        .icon_assist .assist_icon { position: relative; display: inline-block; width: 22px; height: 22px; vertical-align: middle; }
        .icon_assist .assist_icon i { position: absolute !important; left: 0; top: 0; }
        .icon_assist .assist_icon .base_clock { font-size: 18px; line-height: 20px; left: 0px; top: -3px; }
        .icon_assist .assist_icon .assist_badge_plus { right: 0px; bottom: 0px; left: auto; top: auto; font-size: 10px; z-index: 2; background: transparent !important; text-shadow: none !important; }

        .itmbar .icon_hours::after {background: #6A665C;}
        .itmbar .icon_hours i       {color: #6A665C;}
        
        .itmbar .icon_revisit::after {background: #B15ED2;}
        .itmbar .icon_revisit i      {color: #B15ED2;}
        .extra_report .revisit_sum {background: #B15ED2;}
        .itmbar .icon_assist::after {background: #65C891;}
        .itmbar .icon_assist i      {color: #65C891;}
        .itmbar .icon_studies::after {background: #97D0DE;}
        
        /* B style assist icon */
        .itmbar .assist-badge { display: inline-block; width: 22px; height: 22px; position: relative; vertical-align: middle; margin-right: 4px; }
        .itmbar .assist-badge .fa-plus { position: absolute; right: 0; bottom: 0; font-size: 8px; color: #FFF; border-radius: 50%; width: 10px; height: 10px; display: flex; align-items: center; justify-content: center; line-height: 1; transform: none; margin-right: -2px; margin-bottom: -2px; }
        .itmbar .icon_studies i      {color: #97D0DE;}
        

        .memo .input_text {width: 70%; background: #FFFFFF; box-sizing: border-box; border: solid 2px #1E90FF; border-radius: 5px; font-size: 18px; margin: 10px;}
        .memo textarea {width: 82%; height: 80%; display: inline-block; box-sizing: border-box; border-radius: 5px; font-size: 18px; margin: 5px; border:1px solid #ddd;}
        
        /* .memo :nth-child(even) textarea { background: #e3e3e3;} */
        .memo span {font-size: 20px; font-weight: bold; vertical-align: top;}
        .memo li { height: 50px; display: block; line-height: 50px; text-align: center;}

        .c_red {color: #D1635D;}
        .date_icons { display: flex; justify-content: center; margin-top: 5px; min-height: 12px; }
        .date_icons .assist-badge-small { display: inline-block; width: 12px; height: 12px; position: relative; vertical-align: middle; margin: 0 1px; }
        .date_icons .assist-badge-small .fa-clock { position: absolute; left: 0; top: 0; font-size: 10px; color: #000; }
        .date_icons .assist-badge-small .fa-plus { position: absolute; right: 0; bottom: 0; font-size: 6px; color: #000; border-radius: 50%; width: 6px; height: 6px; display: flex; align-items: center; justify-content: center; line-height: 1; margin-right: -1px; margin-bottom: -1px; }
        .icon_small { color: #000; font-size: 10px; margin: 0 1px; }
        .dayDetail {padding: 10px 20px 10px; background-color: #f6f3f1; box-shadow: 2px 2px 16px rgba(0,0,0,0.2); height: calc(100vh - 50px - 50px);}
        .dayDetail>div {padding:10px 0; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between;}
        .dayDetail label {width: 40px; display: block; color: #000; line-height: 28px; text-align: center;}
        /* 기존 스타일 유지 */
        .dayDetail input {width: 24px; background: none; border: none; font-size: 15px; font-weight: bold; color: #000; text-align: center;}
        .dayDetail .time label {width: 60px;}
        .dayDetail .time input {width: 60px;}
        
        /* 재방문, 연구 폼 전용 스타일 */
        .dayDetail .vertical-controls {
            margin-bottom: 15px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 15px;
        }
        .dayDetail .control-group {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .dayDetail .control-group label {
            width: auto;
            margin-right: 10px;
            font-weight: bold;
        }
        .dayDetail .button-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .dayDetail .button-group .value-input {
            width: 45px;
            text-align: center;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 2px 0;
        }
        .dayDetail .vertical-controls a {
            width: 30px;
            margin: 0;
        }
        .dayDetail a, .dayDetail button {padding:6px 0; background-color: #7B716A; line-height: 100%; font-size: 12px; text-align: center; width: 40px; border-radius: 5px; margin:2px; color: #fff; display: block;}
        .dayDetail a:hover, .dayDetail button:hover {background-color: #231306;}
        .dayDetail .time a, .dayDetail .time button {padding:6px 4px;}
        .dayDetail .memo_wrapper {align-items: center;}
        .dayDetail .memo_wrapper label {vertical-align: top;}
        .dayDetail .memo_wrapper textarea {width: calc(100% - 45px); border-radius: 5px; height: 25px; border: 2px solid #B7B2AE;}
        .dayDetail .memo_wrapper .btn1 {background: #7B716A; color: #fff; display: inline-block; width: 60px; vertical-align: top;}

        #app_pop .dim {display: block; position: fixed; z-index: 8; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); top: 0; left: 0; opacity: 0; transition: opacity 300ms; visibility: hidden;}
        #app_pop .wrapper {position: fixed; height: 100vh; width: 75vw; top: 0; background: #fff; box-shadow: 0px 0px 10px rgba(0,0,0,0.2); z-index: 9;
        padding: 70px 30px 30px; transition: right 300ms ease-out; right: -78vw; overflow-y: auto;}
        #app_pop .close_btn {position: absolute; top: 50px; right: 20px; font-size: 24px; color: #333; cursor: pointer; z-index: 10;}
        #app_pop.on .dim {opacity: 1; visibility: visible;}
        #app_pop.on .wrapper {right: 0;}
        #app_pop input[type=radio] {vertical-align: middle;}
        #app_pop label {color: #000; font-weight: bold; vertical-align: middle;}
        #app_pop label+p {padding-left: 25px;}
        #app_pop .desc {font-size: 12px;  margin-left: 25px; line-height: 150%; color: #888;}
        #app_pop h3 {font-size: 18px; font-weight: bold; margin-top: 10px; margin-bottom: 10px; color: #000;}
        #app_pop .btn_red {display: block; padding: 5px 0; text-align: center; border: 1px solid #bd0808; cursor: pointer; color: #bd0808;}
        #app_pop ul {list-style: disc;}
        #app_pop ul li {margin-bottom: 20px; vertical-align: middle; margin-left: 15px;}
        #app_pop ul li strong{margin-bottom: 20px; vertical-align: top; color: #000;}

        @media (orientation: portrait) { /* 세로 */
            .cal, .itmbar {display: block;}
            .memo {display: none;} 
        }

        @media (orientation: landscape) { /* 가로 */
            .cal, .itmbar, .headerbar {display: none;}
            .memo {display: block;}
        }
    </style>    

    <div id="app" class="app">

        <div class="headerbar">
            <p class="title">
                <a class="prev_btn" @click="prevM">
                    <i class="fa-solid fa-chevron-left"></i>
                </a>
                <span><template v-if="cdate != ''">{{ cdate.getFullYear() + ".  " + (cdate.getMonth()+1)}}</template></span>
                <a class="next_btn" @click="nextM">
                    <i class="fa-solid fa-chevron-right"></i>
                </a>
            </p>
            <a class="set_btn" @click="isSettingsOpen = true">
                <i class="fa-solid fa-ellipsis"></i>
            </a>
        </div>

        <template v-if="appUi == 'A'">
            <div class="cal">
                <table>
                    <tr>
                        <th class="weekend">Sun</th>
                        <th>Mon</th>
                        <th>Tus</th>
                        <th>Wed</th>
                        <th>Thu</th>
                        <th>Fri</th>
                        <th class="weekend">Sat</th>
                    </tr>
                    <tr v-for="days, idx1 in week">
                        <template v-for="date, idx2 in days">
                            <template v-if="date.getMonth() == cdate.getMonth()">
                                <td @click.stop="dayCLK($event)" :day="date.getDate()" :class="dayClass(date)"
                                    @mousedown="dayLCLK($event)" @mouseleave="dayLCLK2" @mouseup="dayLCLK2" 
                                    @touchstart="dayLCLK($event)" @touchend="dayLCLK2" @touchcancel="dayLCLK2"
                                    @touchmove="touchMove($event)" >
                                    <div>
                                        <p class="date half">{{ date.getDate() }}</p>
                                        <div class="extra_report">
                                            <template v-if="(getData(date,'revisit') || 0) + (getData(date,'studies') || 0) > 0">
                                                <p class="revisit_sum sub_sum" 
                                                   v-for="i in Math.min(getData(date,'revisit') || 0, 10)"></p>
                                                <p class="studies_sum sub_sum" 
                                                   v-for="i in Math.min(getData(date,'studies') || 0, 10 - Math.min(getData(date,'revisit') || 0, 10))"></p>
                                            </template>
                                        </div>
                                        <p class="hours_sum half">
                                            {{ showTime(date) }}
                                        </p>
                                        <p v-if="getData(date, 'assist') > 0" class="assist_time">{{ formatMinutes(getData(date, 'assist')) }}</p>
                                    </div>
                                </td>
                            </template>
                            <template v-else>
                                <td>
                                    <div>
                                        <p class="date2">{{ date.getDate() }}</p>
                                    </div>
                                </td>
                            </template>
                        </template>
                    </tr>
                </table>
            </div>

            <div class="itmbar">
                <div class="drag_handle" @mousedown.prevent="ysDown($event)" @touchstart.prevent="ysDown($event)">
                    <i class="fa-solid fa-grip-lines"></i>
                </div>
                <h3>{{(cdate.getMonth()+1)}}월 합계({{ monthCombinedTotalHhMm }})</h3>
                <table>
                    <tr>
                        <th><a :class="(this.mode == 'hours') ? 'active':''" class="icon_hours" @click.prevent="setMode('hours')"><i class="fa-solid fa-stopwatch"></i></a><!-- 시간 --></th>
                        <th><a :class="(this.mode == 'assist') ? 'active':''" class="icon_assist" @click.prevent="setMode('assist')" title="보조시간">
                            <span class="assist_icon">
                                <i class="fa-regular fa-clock base_clock"></i>
                                <i class="fa-solid fa-plus assist_badge_plus"></i>
                            </span>
                        </a><!-- 보조시간 --></th>
                        <th><a :class="(this.mode == 'revisit') ? 'active':''" class="icon_revisit" @click.prevent="setMode('revisit')"><i class="fa-solid fa-person-walking-arrow-loop-left"></i></a><!-- 재방문 --></th>
                        <th><a :class="(this.mode == 'studies') ? 'active':''" class="icon_studies" @click.prevent="setMode('studies')"><i class="fa-solid fa-book-open-reader"></i></a><!-- 연구 --></th>
                    </tr>
                    <tr>
                        <td>{{totalDate('hours')}}</td>
                        <td>{{totalDate('assist')}}</td>
                        <td>{{totalDate('revisit')}}</td>
                        <td>{{totalDate('studies')}}</td>
                    </tr>
                </table>
                <div class="year_summary_wrap" :style="{height: ysHeight + 'px'}">
                    <div ref="ysInner">
                        <div class="year_title" style="padding-top:5px;">{{ academicYear(cdate) }} 봉사연도({{ yearTotalCombinedCappedHhMm }})</div>
                        <div class="year_summary" style="padding-top:1px;">
                            <table class="ym_table">
                            <tr>
                                <td v-for="cell in yearRows[0]" :key="'ys1_'+cell.key" @click="goToMonth(cell.m)">
                                    <span class="ym_label">{{ cell.label }}</span>
                                    <span class="ym_time">{{ cell.time }}</span>
                                </td>
                            </tr>
                            <tr>
                                <td v-for="cell in yearRows[1]" :key="'ys2_'+cell.key" @click="goToMonth(cell.m)">
                                    <span class="ym_label">{{ cell.label }}</span>
                                    <span class="ym_time">{{ cell.time }}</span>
                                </td>
                            </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="memo">
                <ul>
                    <li class="border1">
                        <span>FILTER: </span>
                        <input type="text" class="input_text" id="sch_txt" v-model="schtxt" @input="schtxt=$event.target.value"/>
                    </li>
                    <template v-for="day, idx1 in filteredMemoDays" :key="'memo_'+day.getTime()">
                        <li 
                            :class="day.setHours(0,0,0,0) == new Date().setHours(0,0,0,0) ? 'today2':''"
                            :id="'memo_'+day.getDate()" 
                            >   
                            <span :class="day.getDay() == 0 || day.getDay() == 6 ? 'c_red':''">
                                {{ day.getDate() }} ({{ getYoil(day.getDay()) }})
                            </span>
                            <textarea @blur="setMemo($event)" :day="day.getDate()" :key="updateX">{{ getData(day,'memo') }}</textarea>
                        </li>
                    </template>
                </ul>
            </div>
        </template>

        <template v-if="appUi == 'B'">
            <div class="cal2">
                <table>
                    <tr>
                        <th class="weekend">Sun</th>
                        <th>Mon</th>
                        <th>Tus</th>
                        <th>Wed</th>
                        <th>Thu</th>
                        <th>Fri</th>
                        <th class="weekend">Sat</th>
                    </tr>
                    <tr v-for="days, idx1 in week">
                        <template v-for="date, idx2 in days">
                            <template v-if="date.getMonth() == cdate.getMonth()">
                                <td @click="sltCLK($event)" :day="date.getDate()"
                                    :class="dayClass(date)">
                                    <div>
                                        <p class="date half">{{ date.getDate() }}</p>
                                        <div class="date_icons">
                                            <span v-if="getData(date,'assist') > 0" class="assist-badge-small">
                                                <i class="fa-regular fa-clock"></i>
                                                <i class="fa-solid fa-plus"></i>
                                            </span>
                                            <i v-if="getData(date,'revisit') > 0" class="fa-solid fa-person-walking-arrow-loop-left icon_small"></i>
                                            <i v-if="getData(date,'studies') > 0" class="fa-solid fa-book-open-reader icon_small"></i>
                                        </div>
                                        <p class="hours_sum half" :class="{assist_on: !!getData(date,'assist')}">
                                            {{ displayTime(date) }}
                                        </p>
                                    </div>
                                </td>
                            </template>
                            <template v-else>
                                <td>
                                    <div>
                                        <p class="date2">{{ date.getDate() }}</p>
                                    </div>
                                </td>
                            </template>
                        </template>
                    </tr>
                </table>
            </div>

            <div v-if="sltdate != ''" class="dayDetail">
                <div class="time">
                    <div>
                        <label for="f_Hours">시간</label>
                        <input readonly type="text" id="f_Hours" :value="formatMinutes(form.Hours)">
                    </div>
                    <div><a class="increase" @click.prevent="setTimeData(1)">+1m</a><a class="decrease" @click.prevent="setTimeData(-1)">-1m</a></div>
                    <div><a class="increase" @click.prevent="setTimeData(5)">+5m</a><a class="decrease" @click.prevent="setTimeData(-5)">-5m</a></div>
                    <div><a class="increase" @click.prevent="setTimeData(10)">+10m</a><a class="decrease" @click.prevent="setTimeData(-10)">-10m</a></div>
                    <div><a class="increase" @click.prevent="setTimeData(30)">+30m</a><a class="decrease" @click.prevent="setTimeData(-30)">-30m</a></div>
                    <div><a class="increase" @click.prevent="setTimeData(60)">+1h</a><a class="decrease" @click.prevent="setTimeData(-60)">-1h</a></div>
                </div>
                <div class="time">
                    <div>
                        <label for="f_Assist">보조시간</label>
                        <input readonly type="text" id="f_Assist" :value="formatMinutes(form.Assist)">
                    </div>
                    <div><a class="increase" @click.prevent="adjustTime('Assist', 1/60)">+1m</a><a class="decrease" @click.prevent="adjustTime('Assist', -1/60)">-1m</a></div>
                    <div><a class="increase" @click.prevent="adjustTime('Assist', 5/60)">+5m</a><a class="decrease" @click.prevent="adjustTime('Assist', -5/60)">-5m</a></div>
                    <div><a class="increase" @click.prevent="adjustTime('Assist', 10/60)">+10m</a><a class="decrease" @click.prevent="adjustTime('Assist', -10/60)">-10m</a></div>
                    <div><a class="increase" @click.prevent="adjustTime('Assist', 30/60)">+30m</a><a class="decrease" @click.prevent="adjustTime('Assist', -30/60)">-30m</a></div>
                    <div><a class="increase" @click.prevent="adjustTime('Assist', 1)">+1h</a><a class="decrease" @click.prevent="adjustTime('Assist', -1)">-1h</a></div>
                </div>
                <div class="vertical-controls">
                    <div class="control-group">
                        <label for="f_Revisit">재방문</label>
                        <input readonly type="number" id="f_Revisit" v-model.number="form.Revisit" min="0" class="value-input">
                        <div class="button-group">
                            <a class="increase" @click.prevent="setTypeData('Revisit')">+1</a>
                            <a class="decrease" @click.prevent="setTypeData('Revisit', false)">-1</a>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="f_Studies">연구</label>
                        <input readonly type="number" id="f_Studies" v-model.number="form.Studies" min="0" class="value-input">
                        <div class="button-group">
                            <a class="increase" @click.prevent="setTypeData('Studies')">+1</a>
                            <a class="decrease" @click.prevent="setTypeData('Studies', false)">-1</a>
                        </div>
                    </div>
                </div>
                <div class="memo_wrapper">
                    <label for="f_Memo">메모</label>
                    <textarea 
                        id="f_Memo" 
                        v-model="form.Memo"
                        @blur="setDayData"
                        placeholder="메모를 입력하세요">
                    </textarea>
                </div>
            </div>

            <div class="itmbar">
                <div class="drag_handle" @mousedown.prevent="ysDown($event)" @touchstart.prevent="ysDown($event)">
                    <i class="fa-solid fa-grip-lines"></i>
                </div>
                <h3>{{(cdate.getMonth()+1)}}월 합계({{ monthCombinedTotalHhMm }})</h3>
                <ul>
                    <li><i class="fa-solid fa-stopwatch"></i> <span>{{totalDate('hours')}}</span></li><!--시간-->
                    <li title="보조시간">
                        <span class="assist-badge">
                            <i class="fa-regular fa-clock"></i>
                            <i class="fa-solid fa-plus"></i>
                        </span>
                        <span>{{totalDate('assist')}}</span>
                    </li>
                    <li><i class="fa-solid fa-person-walking-arrow-loop-left"></i> <span>{{totalDate('revisit')}}</span></li><!--재방문-->
                    <li><i class="fa-solid fa-book-open-reader"></i> <span>{{totalDate('studies')}}</span></li><!--연구-->
                </ul>
                <div class="year_summary_wrap" :style="{height: ysHeight + 'px'}">
                    <div ref="ysInner">
                        <div class="year_title" style="padding-top:5px;">{{ academicYear(cdate) }} 봉사연도({{ yearTotalCombinedCappedHhMm }})</div>
                        <div class="year_summary" style="padding-top:1px;">
                            <table class="ym_table">
                            <tr>
                                <td v-for="cell in yearRows[0]" :key="'ys1_'+cell.key" @click="goToMonth(cell.m)">
                                    <span class="ym_label">{{ cell.label }}</span>
                                    <span class="ym_time">{{ cell.time }}</span>
                                </td>
                            </tr>
                            <tr>
                                <td v-for="cell in yearRows[1]" :key="'ys2_'+cell.key" @click="goToMonth(cell.m)">
                                    <span class="ym_label">{{ cell.label }}</span>
                                    <span class="ym_time">{{ cell.time }}</span>
                                </td>
                            </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <div id="app_pop" :class="{on: isSettingsOpen}">
            <div class="wrapper" onclick="event.stopPropagation();">
                <a class="close_btn" @click="isSettingsOpen = false"><i class="fa-solid fa-xmark"></i></a>
                <h3>UI 스타일</h3>
                <input type="radio" id="default_style" name="appUi" value="A" @change="newOpt()" v-model="appUi">
                <label for="default_style">기본 스타일</label>
                <p>날짜를 직접 눌러서 봉사내역을 빠르게 입력할 수 있는 방식입니다.</p>
                <p class="desc">- 스마트폰을 가로로 돌려서 메모 입력<br>
                    - 날짜를 길게눌러서 봉사기록 삭제</p>
                <input type="radio" id="classic_style" name="appUi" value="B" @change="newOpt()" v-model="appUi">
                <label for="classic_style">클래식 스타일</label>
                <p>날짜를 누른 다음 해당 날짜의 봉사내역을 입력하는 방식입니다.</p>
                
                <h3>데이터삭제</h3>
                <a @click="cleardata()" class="btn_red">현재 달 데이터삭제</a>

                <h3>안내사항</h3>
                <ul>
                    <li>이 프로그램은 웹앱 형식으로 개발되었습니다. 홈 화면에 <strong>바로가기를 만들어서 사용</strong>해주시기 바랍니다.</li>
                    <li>앱에 입력되는 모든 데이터는 <strong>현재 스마트폰에만 저장</strong>됩니다. 
                        서버에 데이터를 보내거나 보관하지 않기 때문에 바로가기를 삭제하거나 기기를 변경할때 유의하시기 바랍니다.</li>
                </ul>

            </div>
            <div class="dim" @click="isSettingsOpen = false"></div>
        </div>
    </div>

    
    <script>
        // 데이터 유형
        // NAME => hours(봉사시간), assist(보조시간), revisit(재방문), studies(연구)

        const uiAHandler = {
            dayCLK(event) {
                // 기존 UI A dayCLK 로직
                let target = event.currentTarget;
                let day = target.getAttribute('day');
                let cdate = this.cdate;
                let sltDate = new Date(cdate.getFullYear(),cdate.getMonth(),day);
                let jData = this.getData(sltDate, this.mode);
                let nData = (jData == "") ? 1 : parseInt(jData)+1;

                if(!Array.isArray(this.tdate)){
                    console.log("ERROR: 배열이 아닙니다.");
                    this.tdate = [];
                    return;
                }

                let boo = false;
                let tempDate = this.tdate;
                tempDate.forEach((itm, ele) => {
                    if(itm.Date.setHours(0,0,0,0) == sltDate.setHours(0,0,0,0)){
                        if(this.mode === 'hours'){
                            // assist 포함하여 +30 분단위 조정이 아닌 base hours만 증가
                            let curMin = parseInt(this.getData(sltDate,'hours')||0) || 0;
                            itm['hours'] = curMin + 30;
                        } else if(this.mode === 'assist'){
                            let curMin = parseInt(this.getData(sltDate,'assist')||0) || 0;
                            itm['assist'] = curMin + 30;
                        } else {
                            itm[this.mode] = nData;
                        }
                        boo = true;
                    }
                });
                this.tdate = tempDate;

                if(!boo){
                    if(this.mode === 'hours'){
                        this.tdate.push({ Date: sltDate, hours: 30 });
                    }else if(this.mode === 'assist'){
                        this.tdate.push({ Date : sltDate , assist : 30});
                    }else{
                        this.tdate.push({ Date : sltDate , [this.mode] : nData});
                    }
                }

                // ensure reactivity and debounce save
                this.tdate = this.tdate.slice();
                this.scheduleSave(250);
            },
            incData(target){
                let day = target.getAttribute('day');
                let cdate = this.cdate;
                let sltDate = new Date(cdate.getFullYear(),cdate.getMonth(),day);
                let jData = this.getData(sltDate, this.mode);
                let nData = (jData == "") ? 1 : parseInt(jData)+1;

                if(!Array.isArray(this.tdate)){
                    this.tdate = [];
                }

                let boo = false;
                let tempDate = this.tdate;
                tempDate.forEach((itm, ele) => {
                    if(itm.Date.setHours(0,0,0,0) == sltDate.setHours(0,0,0,0)){
                        if(this.mode === 'hours'){
                            let curMin = parseInt(this.getData(sltDate,'hours')||0) || 0;
                            this.$set(itm, 'hours', curMin + 30);
                        } else if(this.mode === 'assist'){
                            let curMin = parseInt(this.getData(sltDate,'assist')||0) || 0;
                            this.$set(itm, 'assist', curMin + 30);
                        } else {
                            this.$set(itm, this.mode, nData);
                        }
                        boo = true;
                    }
                });
                this.tdate = tempDate.slice();

                if(!boo){
                    if(this.mode === 'hours'){
                        this.tdate.push({ Date: sltDate, hours: 30 });
                    } else if(this.mode === 'assist') {
                        this.tdate.push({ Date: sltDate, assist: 30 });
                    } else {
                        this.tdate.push({ Date : sltDate , [this.mode] : nData});
                    }
                    this.tdate = this.tdate.slice();
                }

                this.setTdate();
                this.$forceUpdate();
            },
            dayLCLK(event){
                this.didDrag = false;
                try{
                    // clear previous visual feedback
                    this.clearHoldVisual();
                    let target = event.currentTarget;
                    let day = target.getAttribute('day');
                    if(event && event.touches && event.touches[0]){
                        this.touchY = parseInt(event.touches[0].clientY);
                    }
                    // add visual feedback
                    try { target.classList.add('select'); } catch(e) {}
                    // setup long-press autorepeat (decrement): first at 1500ms, then every 1000ms
                    if(this.holdDelayTimer){ clearTimeout(this.holdDelayTimer); this.holdDelayTimer = null; }
                    if(this.holdTimer){ clearInterval(this.holdTimer); this.holdTimer = null; }
                    this.holdTarget = target;
                    this.holdDelayTimer = setTimeout(()=>{
                        if(this.holdTarget){ uiAHandler.decData.call(this, this.holdTarget); }
                        this.holdTimer = setInterval(()=>{
                            if(this.holdTarget){ uiAHandler.decData.call(this, this.holdTarget); }
                        }, 750);
                    }, 1000);
                }catch(e){}
            },
            dayLCLK2(event){
                if(this.didDrag && event && event.cancelable){
                    event.preventDefault();
                }
                // clear long-press timers
                if(this.holdDelayTimer){ clearTimeout(this.holdDelayTimer); this.holdDelayTimer = null; }
                if(this.holdTimer){ clearInterval(this.holdTimer); this.holdTimer = null; }
                this.holdTarget = null;
                // remove visual feedback only on touchend/touchcancel (robust)
                try {
                    if(event && event.type === 'touchcancel'){
                        this.clearHoldVisual(event.currentTarget);
                    }
                } catch(e) {}
                this.touchY = 0;
            },
            decData(target){
                let day = target.getAttribute('day');
                let cdate = this.cdate;
                let sltDate = new Date(cdate.getFullYear(),cdate.getMonth(),day);
                let jdata = this.getData(sltDate, this.mode);
                if(jdata == "" || jdata == "0") return;

                let ndata = parseInt(jdata)-1;

                this.tdate.forEach((itm, ele) => {
                    if(itm.Date.setHours(0,0,0,0) == sltDate.setHours(0,0,0,0)){
                        if(this.mode == 'hours'){
                            let curMin = parseInt(this.getData(sltDate,'hours')||0) || 0;
                            curMin = Math.max(0, curMin - 30);
                            if(curMin === 0){ this.$delete(itm, 'hours'); } else { this.$set(itm, 'hours', curMin); }
                        } else if(this.mode == 'assist'){
                            let curMin = parseInt(this.getData(sltDate,'assist')||0) || 0;
                            curMin = Math.max(0, curMin - 30);
                            if(curMin === 0){ this.$delete(itm, 'assist'); } else { this.$set(itm, 'assist', curMin); }
                        } else {
                            this.$set(itm, this.mode, ndata);
                        }
                    }
                });
                this.tdate = this.tdate.slice();
                this.interval2 = true;
                this.scheduleSave(200);
            },
            touchMove(evt){
                const now = Date.now();
                if (this.lastTouchTs && (now - this.lastTouchTs) < 50) return; // throttle 50ms
                this.lastTouchTs = now;
                // prevent default scrolling during touch move
                if(evt.cancelable){ evt.preventDefault(); }
                if(this.touchY == 0) this.touchY = parseInt(evt.changedTouches[0].clientY);
                let ctouchY = parseInt(evt.changedTouches[0].clientY);
                let ele = evt.currentTarget;
                if(!ele || !ele.getAttribute || ele.getAttribute('day') == null){
                    let n = evt.target;
                    while(n && (!n.getAttribute || n.getAttribute('day') == null)){
                        n = n.parentElement;
                    }
                    if(n) ele = n;
                }
                if(ctouchY > (this.touchY + 20)) {
                    this.touchY = this.touchY + 20;
                    this.didDrag = true;
                    // cancel long-press while dragging
                    if(this.holdDelayTimer){ clearTimeout(this.holdDelayTimer); this.holdDelayTimer = null; }
                    if(this.holdTimer){ clearInterval(this.holdTimer); this.holdTimer = null; }
                    this.holdTarget = null;
                    uiAHandler.decData.call(this, ele);
                }
                else if(ctouchY < (this.touchY - 20)){
                    this.touchY = this.touchY - 20;
                    this.didDrag = true;
                    // cancel long-press while dragging
                    if(this.holdDelayTimer){ clearTimeout(this.holdDelayTimer); this.holdDelayTimer = null; }
                    if(this.holdTimer){ clearInterval(this.holdTimer); this.holdTimer = null; }
                    this.holdTarget = null;
                    uiAHandler.incData.call(this, ele);
                }
            },
            setMemo(event){
                let target = event.currentTarget;
                let day = target.getAttribute('day');
                let cdate = this.cdate;
                let sltDate = new Date(cdate.getFullYear(),cdate.getMonth(),day);
                let nData = target.value;

                if(!Array.isArray(this.tdate)){
                    console.log("ERROR: 배열이 아닙니다.");
                    this.tdate = [];
                    return;
                }

                let boo = false;
                let tempDate = this.tdate;
                tempDate.forEach((itm, ele) => {
                    if(itm.Date.setHours(0,0,0,0) == sltDate.setHours(0,0,0,0)){
                        itm['memo'] = nData;
                        boo = true;
                    }
                });

                if(!boo) this.tdate.push({ Date : sltDate , 'memo' : nData});

                this.tdate = tempDate;
                this.setTdate();
            }
        };

        const uiBHandler = {
            sltCLK(event) {
                let target = event.currentTarget;
                let day = target.getAttribute('day');
                let sltDate = new Date(this.cdate.getFullYear(), this.cdate.getMonth(), day);
                if (this.sltdate === '' || !this.sameDay(sltDate, this.sltdate)) {
                    this.sltdate = sltDate;
                    this.loadDayData();
                    if (this.appUi === 'B' && !this.uiBScrolled) {
                        this.$nextTick(() => {
                            const dayDetail = document.querySelector('.dayDetail');
                            if (dayDetail) {
                                setTimeout(() => {
                                    const viewportHeight = window.innerHeight;
                                    const scrollPosition = (document.body.scrollHeight - viewportHeight) * 0.8;
                                    window.scrollTo({ top: scrollPosition, behavior: 'smooth' });
                                    this.uiBScrolled = true;
                                }, 50);
                            }
                        });
                    }
                } else {
                    this.sltdate = '';
                    this.loadDayData();
                    this.uiBScrolled = false;
                }
            },
            loadDayData(){
                let sltDay = this.sltdate;
                if(sltDay == "") return;
                if (!this.form || typeof this.form !== 'object') {
                    this.form = { Hours: 0, Assist: 0, Revisit: 0, Studies: 0, Memo: '' };
                }
                let hours = this.getData(sltDay, 'hours') || 0;
                let ctime = this.getData(sltDay, 'ctime');
                let assist = this.getData(sltDay, 'assist') || 0;
                let revisit = this.getData(sltDay, 'revisit') || 0;
                let studies = this.getData(sltDay, 'studies') || 0;
                let memo = this.getData(sltDay, 'memo') || '';
                if (typeof hours === 'string' && hours.includes(':')) {
                    const [h, m] = hours.split(':').map(Number);
                    hours = h * 60 + m;
                }
                if (typeof assist === 'string' && assist.includes(':')) {
                    const [h, m] = assist.split(':').map(Number);
                    assist = h * 60 + m;
                }
                this.$set(this.form, 'Hours', parseInt(hours) || 0);
                this.$set(this.form, 'Assist', parseInt(assist) || 0);
                this.$set(this.form, 'Revisit', parseInt(revisit) || 0);
                this.$set(this.form, 'Studies', parseInt(studies) || 0);
                this.$set(this.form, 'Memo', memo || '');
                this.$set(this.form, 'Ctime', ctime || '');
                this.$nextTick(() => this.$forceUpdate());
            },
            setDayData(){
                let sltDay = this.sltdate;
                if(sltDay == "") return;
                let d_Hours = (this.form && this.form.Hours !== undefined) ? parseInt(this.form.Hours) : 0;
                let d_Ctime = (this.form && this.form.Ctime !== undefined) ? this.form.Ctime : '';
                let d_Assist = (this.form && this.form.Assist !== undefined) ? parseInt(this.form.Assist) : 0;
                let d_Revisit = (this.form && this.form.Revisit !== undefined) ? parseInt(this.form.Revisit) : 0;
                let d_Studies = (this.form && this.form.Studies !== undefined) ? parseInt(this.form.Studies) : 0;
                let d_Memo = (this.form && this.form.Memo !== undefined) ? this.form.Memo : '';
                let found = false;
                this.tdate.forEach((itm) => {
                    if(itm.Date.setHours(0,0,0,0) == sltDay.setHours(0,0,0,0)){
                        found = true;
                        if(d_Hours >= 0) this.$set(itm, 'hours', d_Hours);
                        if(d_Assist >= 0) this.$set(itm, 'assist', d_Assist);
                        if(d_Revisit >= 0) this.$set(itm, 'revisit', d_Revisit);
                        if(d_Studies >= 0) this.$set(itm, 'studies', d_Studies);
                        if(d_Ctime !== undefined) this.$set(itm, 'ctime', d_Ctime);
                        if(d_Memo !== undefined) this.$set(itm, 'memo', d_Memo);
                        if('hour' in itm) delete itm.hour;
                        if('Hours' in itm) delete itm.Hours;
                    }
                });
                if(!found){
                    let newItem = { Date: new Date(sltDay) };
                    if(d_Hours > 0) newItem.hours = d_Hours;
                    if(d_Assist > 0) newItem.assist = d_Assist;
                    if(d_Revisit > 0) newItem.revisit = d_Revisit;
                    if(d_Studies > 0) newItem.studies = d_Studies;
                    if(d_Ctime) newItem.ctime = d_Ctime;
                    if(d_Memo) newItem.memo = d_Memo;
                    this.tdate.push(newItem);
                }
                this.tdate = this.tdate.slice();
                this.interval2 = true;
                this.scheduleSave(200);
            },
            adjustTime(field, delta){
                const minutesToAdd = Math.round(delta * 60);
                const cur = parseInt(this.form[field] || 0) || 0;
                this.$set(this.form, field, Math.max(0, cur + minutesToAdd));
                this.setDayData();
            },
            setTimeData(minute){
                const cur = parseInt(this.form.Hours || 0) || 0;
                const total = Math.max(0, cur + (parseInt(minute) || 0));
                this.$set(this.form, 'Hours', total);
                this.setDayData();
            },
            setTypeData(type, bool=true){
                const key = String(type);
                if(!this.form || !(key in this.form)) return;
                let v = parseInt(this.form[key]) || 0;
                v = bool ? v + 1 : Math.max(0, v - 1);
                this.$set(this.form, key, v);
                this.setDayData();
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            if (typeof Vue !== 'undefined') {
                Vue.config.devtools = false;
            }
        });

        let app = new Vue({
            el: '#app',
            data: {
                week: [],
                days: [],
                tdate: [],
                cdate: new Date(),
                sltdate: '',
                mode: 'hours', 
                appUi: 'A',
                isSettingsOpen: false,
                schtxt: '',
                interval2 : false,
                touchY: 0,
                lastTouchTs: 0,
                didDrag: false,
                updateX: 0,
                // UI A long-press timers
                holdDelayTimer: null,
                holdTimer: null,
                holdTarget: null,
                uiBScrolled: false,
                saveTimer: null,
                form: {
                    Hours: 0,
                    Ctime: '',
                    Assist: 0,
                    Revisit: 0,
                    Studies: 0,
                    Memo: ''
                },
                // Robust helper to clear 'select' class from the held cell
                clearHoldVisual(fallbackEl){
                    try{
                        if(this.holdTarget && this.holdTarget.classList){ this.holdTarget.classList.remove('select'); }
                        else if(fallbackEl && fallbackEl.classList){ fallbackEl.classList.remove('select'); }
                        else {
                            // final fallback: remove from any td.select (should be rare)
                            const sel = document.querySelectorAll('td.select');
                            sel.forEach(el=> el.classList.remove('select'));
                        }
                    }catch(err){}
                },
                // yearly summary drag state
                ysHeight: 0,
                ysDragging: false,
                ysStartY: 0,
                ysStartH: 0,
                _ysOnMove: null,
                _ysOnUp: null,
                _ysMaxH: 0,
                _loadedAY: null
            },
            mounted() {
                this.c_month();
                this.setOpt();

                window.oncontextmenu = function(event) {
                    if(event.target.tagName != 'TEXTAREA'){
                        event.preventDefault(); // 기본 태그 기능 막기
                        event.stopPropagation(); // 이벤트 전달 막기
                        return false;
                    }
                };

                // Global touchend safeguard to clear long-press visual (UI A)
                document.addEventListener('touchend', (e)=>{
                    try{ 
                        if(!this.didDrag) this.clearHoldVisual(); 
                        this.didDrag = false;
                    }catch(err){}
                }, {passive:true});
                document.addEventListener('touchcancel', (e)=>{
                    try{ 
                        if(!this.didDrag) this.clearHoldVisual(); 
                        this.didDrag = false;
                    }catch(err){}
                }, {passive:true});
            },
            methods: {
                // =====================
                // Common methods (공용)
                // =====================
                // helpers
                sameDay(a, b){ return a.setHours(0,0,0,0) === b.setHours(0,0,0,0); },
                pad2(n){ return String(n).padStart(2,'0'); },
                // formatMinutes로 통일
                // 학년도 계산: 9~12월은 다음 해로 귀속 (예: 2023-09~2024-08 => 2024)
                academicYear(d){ const y=d.getFullYear(); const m=d.getMonth(); return (m>=8)?(y+1):y; },
                // 연도기반(학년도) 저장 키: tdate_YYYY
                tkey(){ return "tdate_" + this.academicYear(this.cdate).toString(); },
                c_month(cdate = new Date()) {
                    var startDay = new Date(cdate.getFullYear(), cdate.getMonth(), 0);
                    var prevDate = startDay.getDate();
                    var prevDay = startDay.getDay();

                    this.days = [];
                    
                    for (var i = prevDate - prevDay; i <= prevDate; i++) {
                        let tempDate = new Date(startDay.getFullYear(), startDay.getMonth(), i);
                        this.days.push(tempDate);
                    }

                    let cyear = cdate.getFullYear();
                    let cmonth = cdate.getMonth(); 

                    let boo = true;
                    for (day = 1; boo; day++){
                        let tempDate = new Date(cyear, cmonth, day);
                        this.days.push(tempDate);
                        
                        // 다른 달이 면서 월요일이 되면 멈춘다.
                        if(tempDate.getMonth() != cmonth){
                            if(tempDate.getDay() == 6) boo = false;
                        }
                        if(day > 42) boo = false; // 무한루프 방지
                        if(day == 15) this.cdate = tempDate;
                    }

                    this.week = [];
                    for (var i = 0; i < (this.days.length / 7); i++) {
                        let ii = i * 7;
                        this.week.push(this.days.slice((ii), (ii + 7)));
                    }

                    // 학년도 경계를 넘길 때에만 스토리지 재로딩
                    const newAY = this.academicYear(cdate);
                    if(this._loadedAY !== newAY){
                        this._loadedAY = newAY;
                        this.getTdate();
                    }
                    // this.totaltxt();
                },
                prevM(){ const d=this.cdate; this.c_month(new Date(d.getFullYear(), d.getMonth(), 0)); this.updateX++; },
                nextM(){ const d=this.cdate; this.c_month(new Date(d.getFullYear(), d.getMonth()+1, 1)); this.updateX++; },
                
                // yearly summary drag handlers
                ysDown(evt){
                    this.ysDragging = true;
                    this.ysStartY = (evt.touches && evt.touches[0]) ? evt.touches[0].clientY : evt.clientY;
                    this.ysStartH = this.ysHeight || 0;
                    // measure inner height and set a safe cap
                    this.$nextTick(()=>{
                        const inner = this.$refs.ysInner;
                        const innerH = inner ? (inner.offsetHeight || 0) : 0;
                        const safe = Math.floor(window.innerHeight * 0.5);
                        this._ysMaxH = Math.min(Math.max(innerH, 120), safe); // at least 120px, at most 50vh
                    });
                    if(!this._ysOnMove) this._ysOnMove = (e)=>this.ysMove(e);
                    if(!this._ysOnUp) this._ysOnUp = (e)=>this.ysUp(e);
                    window.addEventListener('mousemove', this._ysOnMove, {passive:false});
                    window.addEventListener('mouseup', this._ysOnUp, {passive:false});
                    window.addEventListener('touchmove', this._ysOnMove, {passive:false});
                    window.addEventListener('touchend', this._ysOnUp, {passive:false});
                    window.addEventListener('touchcancel', this._ysOnUp, {passive:false});
                },
                ysMove(evt){
                    if(!this.ysDragging) return;
                    const y = (evt.touches && evt.touches[0]) ? evt.touches[0].clientY : evt.clientY;
                    const dy = this.ysStartY - y; // drag up => positive
                    const maxH = this._ysMaxH || Math.floor(window.innerHeight * 0.5); // cap at 50vh
                    let nh = this.ysStartH + dy;
                    if(nh < 0) nh = 0;
                    if(nh > maxH) nh = maxH;
                    this.ysHeight = nh;
                    if(evt.cancelable){ evt.preventDefault(); }
                },
                ysUp(){
                    if(!this.ysDragging) return;
                    this.ysDragging = false;
                    // snap: close if small, else snap to content fit height
                    const maxH = this._ysMaxH || Math.floor(window.innerHeight * 0.5);
                    if(this.ysHeight < maxH/2) this.ysHeight = 0; else this.ysHeight = maxH;
                    if(this._ysOnMove){
                        window.removeEventListener('mousemove', this._ysOnMove);
                        window.removeEventListener('touchmove', this._ysOnMove);
                    }
                    if(this._ysOnUp){
                        window.removeEventListener('mouseup', this._ysOnUp);
                        window.removeEventListener('touchend', this._ysOnUp);
                        window.removeEventListener('touchcancel', this._ysOnUp);
                    }
                },

                // =====================
                // UI A methods (UI A 전용)
                // =====================
                dayCLK(event){ if(this.appUi === 'A'){ if(this.interval2){ this.interval2=false; return; } return uiAHandler.dayCLK.call(this, event); } },
                incData(target){
                    if(this.appUi === 'A') return uiAHandler.incData.call(this, target);
                },
                dayLCLK(event){
                    if(this.appUi === 'A') return uiAHandler.dayLCLK.call(this, event);
                },
                dayLCLK2(event){
                    if(this.appUi === 'A') return uiAHandler.dayLCLK2.call(this, event);
                },
                dayClass(day){ if(this.sameDay(day, new Date())) return "today"; if(this.sltdate && this.sameDay(day, this.sltdate)) return "sltday"; return ""; },
                
                decData(target){
                    if(this.appUi === 'A') return uiAHandler.decData.call(this, target);
                },
                touchMove(evt){                    
                    if(this.appUi === 'A') return uiAHandler.touchMove.call(this, evt);
                },

                // =====================
                // UI B methods (UI B 전용)
                // =====================
                totalDate(data){
                    const curMonth = this.cdate.getMonth();
                    if(data==='hours'){
                        // sum only base hours (minutes), do not include assist here
                        let totalMinutes = 0;
                        this.tdate.forEach(itm=>{
                            if(!itm || !itm.Date) return;
                            if(typeof itm.Date === 'string') itm.Date = new Date(itm.Date);
                            if(itm.Date.getMonth()===curMonth && itm.hours !== undefined){
                                totalMinutes += parseInt(itm.hours) || 0;
                            }
                        });
                        return this.formatMinutes(totalMinutes);
                    }
                    if(data==='assist'){
                        let totalMinutes = 0;
                        this.tdate.forEach(itm=>{
                            if(!itm || !itm.Date) return;
                            if(typeof itm.Date === 'string') itm.Date = new Date(itm.Date);
                            if(itm.Date.getMonth()===curMonth && itm.assist !== undefined) {
                                totalMinutes += parseInt(itm.assist) || 0;
                            }
                        });
                        return this.formatMinutes(totalMinutes);
                    }
                    let sum=0;
                    this.tdate.forEach(itm=>{
                        if(!itm || !itm.Date) return;
                        if(typeof itm.Date === 'string') itm.Date = new Date(itm.Date);
                        if(itm.Date.getMonth()===curMonth && itm[data]!==undefined) sum += parseInt(itm[data]);
                    });
                    return sum;
                }
,
                getData(date, data){
                    if(!Array.isArray(this.tdate)){ this.tdate=[]; return 0; }
                    for(const itm of this.tdate){
                        if(typeof itm.Date==="string") itm.Date=new Date(itm.Date);
                        if(this.sameDay(itm.Date, date)){
                            let v = (itm[data]===undefined)?0:itm[data];
                            if(['assist','revisit','studies'].includes(data)) v=parseInt(v);
                            if(data==='memo' && v===0) v="";
                            return v;
                        }
                    }
                    return 0;
                },
                getYoil(int){    
                    let week = ['일', '월', '화', '수', '목', '금', '토'];
                    let weektxt = week[int];
                    
                    return weektxt;
                },
                getTdate(){
                    const txt=this.tkey();
                    const raw=window.localStorage.getItem(txt);
                    let arr = raw? JSON.parse(raw): [];
                    try{ }catch(e){}
                    this.tdate = arr;
                },
                setTdate(){ const txt=this.tkey(); window.localStorage.setItem(txt, JSON.stringify(this.tdate)); },
                // Debounced save to localStorage to avoid frequent writes
                scheduleSave(delay=200){
                    try{ if(this.saveTimer) clearTimeout(this.saveTimer); }catch(e){}
                    this.saveTimer = setTimeout(()=>{
                        this.setTdate();
                        this.saveTimer = null;
                    }, Math.max(50, delay));
                },

                // UI B 날짜 선택 전용
                sltCLK(event) { if(this.appUi === 'B') return uiBHandler.sltCLK.call(this, event); },
                loadDayData(){ if(this.appUi === 'B') return uiBHandler.loadDayData.call(this); },
                setDayData(){ if(this.appUi === 'B') return uiBHandler.setDayData.call(this); },
                
                // adjust helper: delta는 시간 단위(예: 0.5 = 30분)
                adjustTime(field, delta){ if(this.appUi === 'B') return uiBHandler.adjustTime.call(this, field, delta); },
                setTimeData(minute){ if(this.appUi === 'B') return uiBHandler.setTimeData.call(this, minute); },
                setTypeData(type, bool=true){ if(this.appUi === 'B') return uiBHandler.setTypeData.call(this, type, bool); },
                
                setMode(mode){
                    this.mode = mode;
                },
                // UI A memo 전용
                setMemo(event){ if(this.appUi === 'A') return uiAHandler.setMemo.call(this, event); },

                setOpt(){
                    let setting = window.localStorage.getItem('appSetting');
                    let settingJson = JSON.parse(setting);
                    // console.log(settingJson);

                    if(settingJson == null || settingJson == ""){
                        // this.style = 'A'
                    }else{
                        this.appUi = settingJson.appUi;                    
                    }
                },
                newOpt(){
                    let style_type = this.appUi;

                    let settingJson = {"appUi":style_type};
                    settingJson = JSON.stringify(settingJson);

                    if(style_type == 'A') this.sltdate = "";

                    window.localStorage.setItem('appSetting', settingJson);
                },

                cleardata(){
                    if(confirm("현재 달의 모든 봉사기록을 삭제 하시겠습니까?")){
                        const curMonth = this.cdate.getMonth();
                        // 연(학년도) 배열에서 현재 월 항목만 제거
                        this.tdate = (this.tdate||[]).filter(it=>{
                            if(!it || !it.Date) return true;
                            if(typeof it.Date === 'string') it.Date = new Date(it.Date);
                            return it.Date.getMonth() !== curMonth;
                        });
                        this.setTdate();
                        window.location.reload();
                    }
                },
                // 분 단위를 H:MM 형식으로 변환
                formatMinutes(minutes) {
                    if (isNaN(minutes) || minutes === 0) return '';
                    const h = Math.floor(minutes / 60);
                    const m = minutes % 60;
                    return `${h}:${this.pad2(m)}`;
                },
                
                // 시간을 분 단위로 표시 (H:MM -> 분)
                showTime(date) {
                    if (!(date instanceof Date)) return '';
                    const minutes = parseInt(this.getData(date, 'hours') || 0);
                    return this.formatMinutes(minutes);
                },
                
                // 총 시간 표시 (hours + assist)
                displayTime(date) {
                    if (!(date instanceof Date)) return '';
                    const base = parseInt(this.getData(date, 'hours') || 0);
                    const assist = parseInt(this.getData(date, 'assist') || 0);
                    const total = base + assist; // 모두 분 단위이므로 그냥 더함
                    return this.formatMinutes(total);
                },
                
                goToMonth(m){
                    if(typeof m !== 'number' || isNaN(m)) return;
                    const curY = this.cdate.getFullYear();
                    const curM = this.cdate.getMonth();
                    let targetYear;
                    if(curM >= 8){
                        targetYear = (m >= 8) ? curY : (curY + 1);
                    } else {
                        targetYear = (m >= 8) ? (curY - 1) : curY;
                    }
                    this.cdate = new Date(targetYear, m, 1);
                    this.c_month(this.cdate);
                }
            },
            computed: {
                filteredMemoDays(){
                    const days = this.days.filter(d => d.getMonth() == this.cdate.getMonth());
                    const q = (this.schtxt || '').trim();
                    if(!q) return days;
                    return days.filter(day => {
                        if(String(day.getDate()) === q) return true;
                        const memo = this.getData(day,'memo') || '';
                        return String(memo).includes(q);
                    });
                },
                yearMonthTotals(){
                    // academic year months order: Sep(8)→Aug(7)
                    const labels = ['9월','10월','11월','12월','1월','2월','3월','4월','5월','6월','7월','8월'];
                    const order = [8,9,10,11,0,1,2,3,4,5,6,7];
                    const rows = [];
                    for(let i=0;i<12;i++){
                        const m = order[i];
                        let baseMinutes = 0;
                        let assistMinutes = 0;
                        (this.tdate||[]).forEach(it=>{
                            if(!it || !it.Date) return;
                            if(typeof it.Date === 'string') it.Date = new Date(it.Date);
                            if(it.Date.getMonth() === m){
                                if(it.hours) baseMinutes += parseInt(it.hours)||0; // minutes
                                if(it.assist){ assistMinutes += parseInt(it.assist)||0; }
                            }
                        });
                        // cap ONLY the assist portion so base hours are never reduced
                        const roomForAssist = Math.max(0, 55*60 - baseMinutes);
                        const capped = baseMinutes + Math.min(assistMinutes, roomForAssist);
                        const hh = Math.floor(capped/60), mm = capped%60;
                        rows.push({ key: 'm'+m, m, label: labels[i], time: hh+':'+this.pad2(mm) });
                    }
                    return rows;
                },
                yearRows(){
                    // Two rows of 6 months each: Row1 = Sep..Feb, Row2 = Mar..Aug
                    const findIdx = (m)=> this.yearMonthTotals.findIndex(x=>x.key==='m'+m);
                    const row1Months = [8,9,10,11,0,1];
                    const row2Months = [2,3,4,5,6,7];
                    const row1 = row1Months.map(m=> this.yearMonthTotals[findIdx(m)]).filter(Boolean);
                    const row2 = row2Months.map(m=> this.yearMonthTotals[findIdx(m)]).filter(Boolean);
                    return [row1, row2];
                },
                monthCombinedTotalHhMm(){
                    // Sum current month: base hours (minutes) + assist (assist*30 minutes)
                    const curMonth = this.cdate.getMonth();
                    let baseMinutes = 0;
                    let assistMinutes = 0;
                    (this.tdate||[]).forEach(it=>{
                        if(!it || !it.Date) return;
                        if(typeof it.Date === 'string') it.Date = new Date(it.Date);
                        if(it.Date.getMonth() !== curMonth) return;
                        if(it.hours) baseMinutes += parseInt(it.hours) || 0; // minutes
                        if(it.assist) assistMinutes += parseInt(it.assist)||0;
                    });
                    // cap ONLY the assist portion so base hours are never reduced
                    const roomForAssist = Math.max(0, 55*60 - baseMinutes);
                    const capped = baseMinutes + Math.min(assistMinutes, roomForAssist);
                    const hh = Math.floor(capped/60), mm = capped % 60;
                    return hh + ':' + this.pad2(mm);
                },
                yearTotalCombinedCappedHhMm(){
                    // Sum the academic year's 12 months using the same capped-per-month combined totals
                    // Reuse yearMonthTotals which already computes combined+capped times per month
                    let totalMinutes = 0;
                    this.yearMonthTotals.forEach(cell=>{
                        const [hh,mm] = String(cell.time).split(':');
                        const m = (parseInt(hh)||0)*60 + (parseInt(mm)||0);
                        totalMinutes += m;
                    });
                    const hh = Math.floor(totalMinutes/60), mm = totalMinutes%60;
                    return hh + ':' + this.pad2(mm);
                }
            },
            watch: {
                sltdate(){
                    if(this.sltdate != "") {
                        setTimeout(()=>{
                            app.loadDayData();
                        },0);
                    }
                }
            }
        });
    </script>
</body>
</html>